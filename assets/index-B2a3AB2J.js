(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const U=["#0f380f","#306230","#8bac0f","#9bbc0f"],W=["#191E21","#F1F1F1","#31318F","#53A428","#D20E13","#F3CF11"],H=["#191E21","#F1F1F1","#31318F","#53A428","#D20E13","#B85E1C","#F3CF11"],w={default:["#000","#fff"],gameboy:U,spectra6:W,acep:H},V=["#0F0","#3F0","#7F0","#FF0"],j=["#000000","#FFFFFF","#0000FF","#00FF00","#FF0000","#FFFF00"],G=["#000","#fff","#0000FF","#00FF00","#FF0000","#FF8000","#FFFF00"],b={default:["#e6e6e6","#212121"],gameboy:V,spectra6:j,acep:G},T=t=>t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(e,n,a,o)=>"#"+n+n+a+a+o+o).substring(1).match(/.{2}/g).map(e=>parseInt(e,16)),Q=(t,e,{originalColors:n,replaceColors:a})=>{const o=t.getContext("2d"),r=t.width,s=t.height,l=e.getContext("2d"),f=o.getImageData(0,0,r,s);var u=0;const m=n.map(d=>T(d)),i=a.map(d=>T(d));for(let d=0;d<f.data.length;d+=4){const h=m.find(c=>f.data[d]==c[0]&&f.data[d+1]==c[1]&&f.data[d+2]==c[2]);if(h){const c=m.indexOf(h),g=i[c];if(!g)return;f.data[d]=g[0],f.data[d+1]=g[1],f.data[d+2]=g[2]}else u++}u>0&&console.warn(`replaceColors: ${u} pixels were not replaced. Check if the colors match exactly.`),e.width=r,e.height=s,l.putImageData(f,0,0)},v={floydSteinberg:()=>[{offset:[1,0],factor:7/16},{offset:[-1,1],factor:3/16},{offset:[0,1],factor:5/16},{offset:[1,1],factor:1/16}],falseFloydSteinberg:()=>[{offset:[1,0],factor:3/8},{offset:[0,1],factor:3/8},{offset:[1,1],factor:2/8}],jarvis:()=>[{offset:[1,0],factor:7/48},{offset:[2,0],factor:5/48},{offset:[-2,1],factor:3/48},{offset:[-1,1],factor:5/48},{offset:[0,1],factor:7/48},{offset:[1,1],factor:5/48},{offset:[2,1],factor:3/48},{offset:[-2,2],factor:1/48},{offset:[-1,2],factor:3/48},{offset:[0,2],factor:4/48},{offset:[1,2],factor:3/48},{offset:[2,2],factor:1/48}],stucki:()=>[{offset:[1,0],factor:8/42},{offset:[2,0],factor:4/42},{offset:[-2,1],factor:2/42},{offset:[-1,1],factor:4/42},{offset:[0,1],factor:8/42},{offset:[1,1],factor:4/42},{offset:[2,1],factor:2/42},{offset:[-2,2],factor:1/42},{offset:[-1,2],factor:2/42},{offset:[0,2],factor:4/42},{offset:[1,2],factor:2/42},{offset:[2,2],factor:1/42}],burkes:()=>[{offset:[1,0],factor:8/32},{offset:[2,0],factor:4/32},{offset:[-2,1],factor:2/32},{offset:[-1,1],factor:4/32},{offset:[0,1],factor:8/32},{offset:[1,1],factor:4/32},{offset:[2,1],factor:2/32}],sierra3:()=>[{offset:[1,0],factor:5/32},{offset:[2,0],factor:3/32},{offset:[-2,1],factor:2/32},{offset:[-1,1],factor:4/32},{offset:[0,1],factor:5/32},{offset:[1,1],factor:4/32},{offset:[2,1],factor:2/32},{offset:[-1,2],factor:2/32},{offset:[0,2],factor:3/32},{offset:[1,2],factor:2/32}],sierra2:()=>[{offset:[1,0],factor:4/16},{offset:[2,0],factor:3/16},{offset:[-2,1],factor:1/16},{offset:[-1,1],factor:2/16},{offset:[0,1],factor:3/16},{offset:[1,1],factor:2/16},{offset:[2,1],factor:1/16}],"Sierra2-4A":()=>[{offset:[1,0],factor:2/4},{offset:[-2,1],factor:1/4},{offset:[-1,1],factor:1/4}]},Y=t=>{const e=t[0]<8?t[0]:8,n=t[1]<8?t[1]:8,a=[[0,48,12,60,3,51,15,63],[32,16,44,28,35,19,47,31],[8,56,4,52,11,59,7,55],[40,24,36,20,43,27,39,32],[2,50,14,62,1,49,13,61],[34,18,46,30,33,17,45,29],[10,58,6,54,9,57,5,53],[42,26,38,22,41,25,37,21]];if(e===8&&n===8)return a;const o=[];let r=0;for(r;r<n;r++)o.push([]);o.forEach((l,f)=>{let u=0;for(u;u<e;u++)l.push(a[u][f])});const s={};return o.flat().sort((l,f)=>l-f).forEach((l,f)=>s[l]=f),o.forEach((l,f)=>{l.forEach((u,m)=>{o[f][m]=s[u]})}),o};function K(t){const e=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;t=t.replace(e,(a,o,r,s)=>o+o+r+r+s+s);const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return n?[parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16)]:null}const X={hexToRgb:K};function _(t,e){return Math.floor(Math.random()*(e-t+1))+t}const B={randomInteger:_},x=(t,e)=>{const n=e.map(o=>({distance:J(o,t),color:o}));let a;return n.forEach(o=>{a?o.distance<a.distance&&(a=o):a=o}),a.color[3]||a.color.push(255),a.color},J=(t,e)=>{const n=t[0]-e[0],a=t[1]-e[1],o=t[2]-e[2];return Math.sqrt(n*n+a*a+o*o)},Z={ditheringType:"errorDiffusion",errorDiffusionMatrix:"floydSteinberg",serpentine:!1,orderedDitheringType:"bayer",orderedDitheringMatrix:[4,4],randomDitheringType:"blackAndWhite",palette:"default",sampleColorsFromImage:!1,numberOfSampleColors:10},z=async(t,e,n)=>{if(!t||!e)return;const o=t.getContext("2d").getImageData(0,0,t.width,t.height),r={...Z,...n},s=o.width;let l=[];!r.palette||r.sampleColorsFromImage===!0||(l=ft(r.palette));function f(c,g){o.data[c]=g[0],o.data[c+1]=g[1],o.data[c+2]=g[2],o.data[c+3]=g[3]}const u=Y([r.orderedDitheringMatrix[0],r.orderedDitheringMatrix[1]]);let m,i,d,h;for(m=0;m<=o.data.length;m+=4){const c=m;h=L(c,o.data),(!r.ditheringType||r.ditheringType==="quantizationOnly")&&(i=x(h,l),f(c,i)),r.ditheringType==="random"&&r.randomDitheringType==="rgb"&&(i=ot(h),f(c,i)),r.ditheringType==="random"&&r.randomDitheringType==="blackAndWhite"&&(i=rt(h),f(c,i)),r.ditheringType==="ordered"&&(i=nt(h,at(c/4,s),u,64),i=x(i,l),f(c,i));const g=v[r.errorDiffusionMatrix]()||v.floydSteinberg();r.ditheringType==="errorDiffusion"&&(i=x(h,l),f(c,i),d=tt(h,i),g.forEach(y=>{const q=y.offset[0]*4+y.offset[1]*4*s,D=c+q;if(!o.data[D])return;const N=et(L(D,o.data),d,y.factor);f(D,N)}))}return ct(o,e)},L=(t,e)=>[e[t],e[t+1],e[t+2],e[t+3]],tt=(t,e)=>t.map((a,o)=>a-e[o]),et=(t,e,n)=>t.map((a,o)=>a+e[o]*n),ot=t=>t.map(e=>e<B.randomInteger(0,255)?0:255),rt=t=>(t[0]+t[1]+t[2])/3<B.randomInteger(0,255)?[0,0,0,255]:[255,255,255,255],nt=(t,e,n,a)=>{const o=n[e[1]%n.length][e[0]%n[0].length]/(n.length*n[0].length);return t.map(r=>r+o*a)},at=(t,e)=>[t%e,Math.floor(t/e)],ft=t=>(typeof t=="string"?w[t]:t).map(n=>X.hexToRgb(n)),ct=(t,e)=>(e.width=t.width,e.height=t.height,e.getContext("2d").putImageData(t,0,0),e);function st(t){const e=t.toLowerCase();return w[e]||w.default}function it(t){const e=t.toLowerCase();return b[e]||b.default}const E=document.getElementById("fileInput"),F=document.getElementById("inputCanvas"),I=document.getElementById("outputCanvas"),M=document.getElementById("deviceColorsCanvas"),dt=document.getElementById("downloadLink"),lt=document.getElementById("downloadLink"),P=document.getElementById("paletteSelect"),S=document.getElementById("deviceColorsSelect"),O=document.getElementById("ditheringType"),R=document.getElementById("errorDiffusionMatrix"),A=document.getElementById("orderedDitheringMatrixW"),k=document.getElementById("orderedDitheringMatrixH"),$=document.getElementById("randomDitheringType");let p=null;window.addEventListener("DOMContentLoaded",async()=>{const t=new Image;t.src="/epdoptimize/example-dither.jpg",await t.decode(),p=t,await C()});function ut(t){const e=O.value,n=R.value,a=[parseInt(A.value,10),parseInt(k.value,10)],o=$.value;return{ditheringType:e,errorDiffusionMatrix:n,orderedDitheringMatrix:a,randomDitheringType:o,palette:t,calibrate:!0}}async function C(){if(!p)return;F.width=p.width,F.height=p.height,F.getContext("2d").drawImage(p,0,0);const e=P.value,n=S.value,a=st(e),o=it(n),r=ut(a);await z(F,I,r),dt.href=I.toDataURL("image/png"),Q(I,M,{originalColors:a,replaceColors:o}),lt.href=M.toDataURL("image/png")}E.addEventListener("change",async()=>{var n;if(!((n=E.files)!=null&&n.length))return;const t=E.files[0],e=new Image;e.src=URL.createObjectURL(t),await e.decode(),p=e,await C()});[P,S,O,R,A,k,$].forEach(t=>{console.log("Adding change listener to",t),t.addEventListener("change",async()=>{await C()}),t instanceof HTMLInputElement&&t.addEventListener("input",async()=>{await C()})});
